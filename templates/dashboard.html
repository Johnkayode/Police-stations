<html lang="en">
{% load static %}
<head>
    <title>Police Stations Near You</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
     <!-- Fontawesome -->
     <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
</head>

<body>
    <style>
        body{
            font-family: Poppins;
            height: 83vh;
            overflow: hidden;
        }
        .navbar-brand span{
            font-size: 30px;
            font-weight: 700;
            font-family: Poppins;
        }

        #map {
            height: 83vh;
        }

        #page{
            height: 83vh;
            overflow-y: scroll;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;
        }

        #page::-webkit-scrollbar {
            display: none;
          }

        @media (max-width: 991.98px) { 
            #map{
                height: 43vh;
            }
            #page{
                height: 50vh;
            }
         }

         .station-item{
            padding: 15px 12px;
            border: 1px solid grey;
            border-radius: 25px;
         }
          


    </style>
    
    
    <!-- Navbar -->
    <nav class="navbar navbar-light py-3 px-5">
        <a class="navbar-brand" href="#">
            <span class="h3 mx-2 brand-text">Police</span>
        </a>
        <ul class="nav justify-content-end">
            <a href="{% url 'accounts:logout' %}"><i class="fas fa-sign-out fa-2x"></i></a>
        </ul>
    </nav>

    <div class="row">
        <div class="col-lg-6">
            <div class="" id=map>
            </div>
        </div>
        <div class="col-lg-6">
            <div id='page' class="container">
                <h3 class='text-center text-light mb-4'> <i class='text-light fa fa-map-marker'></i> Police Stations near you </h3>
        
                <li class='list-unstyled mt-4' id='stations'>
                    
                </li>
            </div>
        </div>
    </div>



    <!-- Custom JS -->
    <script>
    let pos;
    let map;
    let bounds;
    let infoWindow;
    let currentInfoWindow;
    let service;
    let infoPane;
    function initMap() {
    // Initialize variables
    bounds = new google.maps.LatLngBounds();
    infoWindow = new google.maps.InfoWindow;
    currentInfoWindow = infoWindow;
    /* TODO: Step 4A3: Add a generic sidebar */

    // Try HTML5 geolocation
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
        pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };

        console.log(pos)

        
        map = new google.maps.Map(document.getElementById('map'), {
            center: pos,
            zoom: 15
        });
        bounds.extend(pos);

        infoWindow.setPosition(pos);
        infoWindow.setContent('Location found.');
        infoWindow.open(map);
        map.setCenter(pos);

        

        /* TODO: Step 3B2, Call the Places Nearby Search */
        // Call Places Nearby Search on user's location
        getNearbyPlaces(pos);
        }, () => {
        // Browser supports geolocation, but user has denied permission
        handleLocationError(true, infoWindow);
        });
    } else {
        // Browser doesn't support geolocation
        handleLocationError(false, infoWindow);
    }
    }

    // Handle a geolocation error
    function handleLocationError(browserHasGeolocation, infoWindow) {
    // Set default location to Sydney, Australia
    pos = { lat: -33.856, lng: 151.215 };
    map = new google.maps.Map(document.getElementById('map'), {
        center: pos,
        zoom: 15
    });

    // Display an InfoWindow at the map center
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
        'Geolocation permissions denied. Using default location.' :
        'Error: Your browser doesn\'t support geolocation.');
    infoWindow.open(map);
    currentInfoWindow = infoWindow;

    /* TODO: Step 3B3, Call the Places Nearby Search */
    // Call Places Nearby Search on the default location
    getNearbyPlaces(pos);
    }

    /* TODO: Step 3B1, Call the Places Nearby Search */
    // Perform a Places Nearby Search Request
    function getNearbyPlaces(position) {
    let request = {
        location: position,
        rankBy: google.maps.places.RankBy.DISTANCE,
        keyword: 'police'
    };

    service = new google.maps.places.PlacesService(map);
    service.nearbySearch(request, nearbyCallback);
    }

    // Handle the results (up to 20) of the Nearby Search
    function nearbyCallback(results, status) {
    if (status == google.maps.places.PlacesServiceStatus.OK) {
        console.log(results)
        buildList(results);
        createMarkers(results);
    }
    }

    /* TODO: Step 3C, Generate markers for search results */
    // Set markers at the location of each place result
    function createMarkers(places) {
    places.forEach(place => {
        let marker = new google.maps.Marker({
        position: place.geometry.location,
        map: map,
        title: place.name
        });

        /* TODO: Step 4B: Add click listeners to the markers */
        google.maps.event.addListener(marker, 'click', () => {
            let request = {
            placeId: place.place_id,
            fields: ['name', 'formatted_address', 'geometry', 'rating',
                'website', 'photos']
            };
        
            /* Only fetch the details of a place when the user clicks on a marker.
            * If we fetch the details for all place results as soon as we get
            * the search response, we will hit API rate limits. */
            service.getDetails(request, (placeResult, status) => {
            // showDetails(placeResult, marker, status)
            });
        });

        // Adjust the map bounds to include the location of this marker
        bounds.extend(place.geometry.location);
    });
    /* Once all the markers have been placed, adjust the bounds of the map to
    * show all the markers within the visible area. */
    map.fitBounds(bounds);
    }

    
    function buildList(results){
        var wrapper = document.getElementById('stations');
        console.log(results)
        for(var i in results){
            var shop = `
                <ul class='station-item'>
                    <div class="row">
                        <div class="col-3">
                            <img src='${results[i].icon}' class='icon' style="background-color:'${results[i].icon_backgrounf_color}'">
                        </div>
                        <div class='col-9'>
                            <h4 class='mt-2'>${results[i].name}</h4>
                            <p class='mt-2'>${results[i].vicinity}</p>
                        </div>
                    </div>
                </ul>
            `
            wrapper.innerHTML += shop;
        }

        
    }
    
</script>
    <!-- Google Maps -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAYV6Jyp7Ir47jZSnyVazncxP7hThKX-J8&libraries=places&callback=initMap"></script>
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
</body>